<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stone Production Simulation</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --tech-bg: #0f172a; /* Slate 900 */
            --tech-card: #1e293b; /* Slate 800 */
            --tech-border: #334155; /* Slate 700 */
            --tech-text-main: #f8fafc; /* Slate 50 */
            --tech-text-muted: #e2e8f0; /* Slate 200 */
            
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-emerald: #10b981;
        }

        body {
            font-family: 'Inter', sans-serif !important;
            background-color: var(--tech-bg);
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            color: var(--tech-text-main);
            overflow-x: hidden;
            user-select: none;
        }

        /* --- VISUALIZER ENGINE --- */
        .fluent-viewport {
            background: radial-gradient(circle at 50% 50%, #1e293b 0%, #0f172a 100%);
            position: relative;
            overflow: hidden;
            perspective: 1200px;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fluent-mesh {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                linear-gradient(rgba(59, 130, 246, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(59, 130, 246, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 0;
            opacity: 0.4;
            pointer-events: none;
        }

        .scene-3d {
            position: relative;
            transform-style: preserve-3d;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* SCHEMATIC CUBE ENHANCEMENTS */
        .schematic-wrapper {
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(-20deg) rotateY(35deg); /* Adjusted rotation for LTR perspective */
            transition: width 0.5s ease, height 0.5s ease, transform 0.5s ease;
        }

        .schematic-face {
            position: absolute;
            box-sizing: border-box;
            background: rgba(59, 130, 246, 0.1); 
            border: 2px solid rgba(96, 165, 250, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            backface-visibility: visible;
            box-shadow: inset 0 0 40px rgba(59, 130, 246, 0.15);
            transition: all 0.3s ease;
        }

        .schematic-face:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(96, 165, 250, 0.9);
            box-shadow: inset 0 0 60px rgba(59, 130, 246, 0.3);
        }

        .face-top    { background: rgba(59, 130, 246, 0.25); border-color: rgba(147, 197, 253, 0.8); }
        .face-right  { background: rgba(37, 99, 235, 0.15); }
        .face-front  { background: rgba(29, 78, 216, 0.1); }

        /* Measurement Lines & Labels */
        .measure-line {
            position: absolute;
            background: #cbd5e1;
            z-index: 20;
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
        }
        .measure-cap {
            position: absolute;
            width: 8px;
            height: 2px;
            background: #cbd5e1;
        }

        .measure-label {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: #38bdf8;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 900;
            font-family: 'Inter', monospace;
            border: 1px solid rgba(56, 189, 248, 0.5);
            white-space: nowrap;
            transform-style: preserve-3d;
            transform: translateZ(40px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 30;
        }

        /* OTHER 3D ELEMENTS */
        .machine-base {
            width: 320px;
            height: 24px;
            background: linear-gradient(90deg, #334155, #475569, #334155);
            border-radius: 4px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            transform: rotateX(45deg);
            margin-bottom: -15px;
        }
        .machine-frame {
            width: 300px;
            height: 200px;
            border: 12px solid #475569;
            border-bottom: none;
            background: rgba(15, 23, 42, 0.5);
            display: flex;
            justify-content: center;
            position: relative;
            backdrop-filter: blur(6px);
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }
        .saw-blades {
            width: 90%;
            height: 100%;
            display: flex;
            justify-content: space-evenly;
            background: repeating-linear-gradient(90deg, transparent, transparent 18px, rgba(203, 213, 225, 0.3) 19px, rgba(203, 213, 225, 0.3) 20px);
        }

        /* GLOBE */
        .market-globe {
            width: 260px;
            height: 260px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #3b82f6, #020617);
            box-shadow: inset -20px -20px 60px rgba(0,0,0,0.9), 0 0 60px rgba(59, 130, 246, 0.25);
            position: relative;
            overflow: hidden;
            transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .globe-grid {
            position: absolute;
            width: 100%; height: 100%;
            background: 
                linear-gradient(transparent 45%, rgba(255,255,255,0.08) 50%, transparent 55%),
                linear-gradient(90deg, transparent 45%, rgba(255,255,255,0.08) 50%, transparent 55%);
            background-size: 35px 35px;
            border-radius: 50%;
            transform: rotate(15deg);
            animation: spin-globe 40s linear infinite;
        }
        @keyframes spin-globe { from { background-position: 0 0; } to { background-position: 100% 0; } }

        /* UI ELEMENTS */
        .glass-panel {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border-radius: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glass-panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
        }

        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background-color: #475569; }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease-out;
        }

        .wizard-input-group {
            border-left: 3px solid transparent;
            padding-left: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .wizard-input-group:focus-within {
            border-left-color: var(--accent-blue);
            background-color: rgba(59, 130, 246, 0.1);
            padding-left: 16px;
        }

        /* Improved Text Visibility Classes */
        .text-label { color: #f1f5f9; } 
        .text-desc { color: #cbd5e1; } 
        
        input[type=range] { accent-color: var(--accent-blue); }

        /* Dimension Tags */
        .dim-tag {
            background: rgba(15, 23, 42, 0.95);
            padding: 8px 18px;
            border-radius: 10px;
            border: 1px solid #3b82f6;
            color: #fff;
            font-size: 15px;
            font-weight: 800;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            white-space: nowrap;
            z-index: 20;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .dim-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 25px rgba(59, 130, 246, 0.3);
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 6s ease-in-out infinite; }

        @media print {
            .no-print { display: none !important; }
            
            @page {
                size: A4 landscape;
                margin: 5mm;
            }

            html, body, #root { 
                height: auto !important; 
                min-height: 0 !important;
                overflow: visible !important; 
                background: white !important; 
                color: black !important;
                margin: 0 !important;
                padding: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                zoom: 0.85; 
            }

            .visualizer-viewport, .fluent-viewport, nav { display: none !important; }
            .modal-backdrop { display: none !important; }
            
            .flex-col, .h-screen, .min-h-screen, .h-full, .overflow-hidden, .overflow-y-auto, .custom-scroll {
                height: auto !important;
                width: 100% !important;
                overflow: visible !important;
                display: block !important;
                position: static !important;
            }

            main {
                display: block !important;
                height: auto !important;
                overflow: visible !important;
            }
            
            .glass-panel { 
                background: white !important; 
                border: 1px solid #ccc !important; 
                color: black !important; 
                box-shadow: none !important; 
                break-inside: avoid;
                page-break-inside: avoid;
                margin-bottom: 20px;
            }

            .text-white, .text-slate-100, .text-slate-200, .text-slate-300, .text-slate-400 {
                color: black !important;
            }
            .bg-slate-800, .bg-slate-900 {
                background: transparent !important;
            }

            .grid {
                display: grid !important;
            }

            .print\:break-before-page { 
                page-break-before: always !important; 
                break-before: page !important;
                margin-top: 2rem !important;
            }
        }
    </style>
</head>
<body class="bg-slate-900 min-h-screen font-[Inter] text-slate-100 selection:bg-blue-500 selection:text-white">
    <div id="root" class="min-h-screen"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- UTILS ---
        const fmt = (n) => {
            if (n === undefined || n === null || isNaN(n)) return '0';
            return new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 }).format(n);
        };

        const parseFormattedNumber = (str) => {
            if (!str) return '';
            const num = parseFloat(str.toString().replace(/,/g, ''));
            return isNaN(num) ? '' : num;
        };

        // --- ICONS ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`shrink-0 ${className}`}>
                {path}
            </svg>
        );

        // --- PREMIUM LOGO COMPONENT ---
        const SlabLogo = () => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="24" height="24" fill="none" className="shrink-0 overflow-visible">
                <defs>
                    <linearGradient id="stoneSurfaceLeft" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stopColor="#334155"/>
                        <stop offset="100%" stopColor="#1e293b"/>
                    </linearGradient>
                    <linearGradient id="stoneSurfaceRight" x1="100%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stopColor="#475569"/>
                        <stop offset="100%" stopColor="#334155"/>
                    </linearGradient>
                    <linearGradient id="stoneTop" x1="50%" y1="0%" x2="50%" y2="100%">
                        <stop offset="0%" stopColor="#64748b"/>
                        <stop offset="100%" stopColor="#475569"/>
                    </linearGradient>
                    <linearGradient id="gearMetal" x1="0%" y1="50%" x2="100%" y2="50%">
                        <stop offset="0%" stopColor="#cbd5e1"/>
                        <stop offset="20%" stopColor="#f8fafc"/>
                        <stop offset="50%" stopColor="#94a3b8"/>
                        <stop offset="80%" stopColor="#f8fafc"/>
                        <stop offset="100%" stopColor="#cbd5e1"/>
                    </linearGradient>
                    <filter id="laserGlow">
                        <feGaussianBlur stdDeviation="1.5" result="coloredBlur"/>
                        <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                </defs>
                <g transform="translate(0, 5)">
                    <path d="M50 5 L80 25 V50 H20 V25 L50 5 Z" fill="#1e293b"/>
                    <path d="M50 5 L50 50 L20 50 L20 25 Z" fill="url(#stoneSurfaceLeft)" stroke="#475569" strokeWidth="0.5"/>
                    <path d="M50 5 L50 50 L80 50 L80 25 Z" fill="url(#stoneSurfaceRight)" stroke="#475569" strokeWidth="0.5"/>
                    <path d="M50 5 L50 50" stroke="#94a3b8" strokeWidth="0.5" strokeOpacity="0.5"/>
                    <path d="M50 5 L80 25 L50 35 L20 25 Z" fill="url(#stoneTop)" opacity="0.6"/>
                    <g transform="translate(50, 50)">
                        <path d="M-30 0 A30 30 0 0 0 30 0 Z" fill="url(#gearMetal)"/>
                        <g fill="url(#gearMetal)">
                            <path d="M-36 0 H-30 V10 H-36 Z" transform="rotate(15)"/>
                            <path d="M-36 0 H-30 V10 H-36 Z" transform="rotate(45)"/>
                            <path d="M-36 0 H-30 V10 H-36 Z" transform="rotate(75)"/>
                            <path d="M-36 0 H-30 V10 H-36 Z" transform="rotate(105)"/>
                            <path d="M-36 0 H-30 V10 H-36 Z" transform="rotate(135)"/>
                            <path d="M-36 0 H-30 V10 H-36 Z" transform="rotate(165)"/>
                        </g>
                        <circle r="12" fill="#1e293b" stroke="#475569" strokeWidth="2"/>
                        <circle r="6" fill="#3b82f6" fillOpacity="0.8" filter="url(#laserGlow)"/>
                    </g>
                    <rect x="15" y="48" width="70" height="4" fill="#3b82f6" filter="url(#laserGlow)"/>
                    <rect x="15" y="49" width="70" height="2" fill="white" opacity="0.8"/>
                </g>
            </svg>
        );

        const Icons = {
            Dashboard: <Icon path={<><rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" /></>} />,
            Play: <Icon path={<polygon points="5 3 19 12 5 21 5 3" />} />,
            Dollar: <Icon path={<><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></>} />,
            Box: <Icon path={<><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" /><path d="m3.3 7 8.7 5 8.7-5" /><path d="M12 22V12" /></>} />,
            Zap: <Icon path={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />} />,
            TrendingUp: <Icon path={<polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />} />,
            Info: <Icon path={<><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></>} />,
            History: <Icon path={<path d="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" />} />, 
            Restart: <Icon path={<path d="M1 4v6h6M23 20v-6h-6M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" />} />,
            Save: <Icon path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            Trash: <Icon path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} />,
            Refresh: <Icon path={<path d="M23 4v6h-6M1 20v-6h6" />} />,
            Eye: <Icon path={<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>} />,
            Help: <Icon path={<><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><line x1="12" y1="17" x2="12.01" y2="17" /></>} />, 
            Alert: <Icon path={<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4m0 4h.01" />} />,
            Print: <Icon path={<><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect x="6" y="14" width="12" height="8" /></>} />,
            Next: <Icon path={<polyline points="9 18 15 12 9 6" />} />,
            Prev: <Icon path={<polyline points="15 18 9 12 15 6" />} />,
            Check: <Icon path={<polyline points="20 6 9 17 4 12" />} />,
            X: <Icon path={<><path d="M18 6 6 18" /><path d="m6 6 12 12" /></>} />,
            Settings: <Icon path={<><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></>} />,
            Production: <Icon path={<><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z" /><path d="M17 18h1" /><path d="M12 18h1" /><path d="M7 18h1" /></>} />, 
            Layers: <Icon path={<><polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 17 12 22 22 17" /><polyline points="2 12 12 17 22 12" /></>} />,
            Back: <Icon path={<path d="M19 12H5M12 19l-7-7 7-7"/>} />,
            Factory: <Icon path={<polygon points="12 2 21 7 21 17 12 22 3 17 3 7" />} />, 
            Logo: <SlabLogo />, 
            Clipboard: <Icon path={<><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><rect x="8" y="2" width="8" height="4" rx="1" ry="1" /></>} />
        };

        const LABELS = {
            totalStockTons: "Stone Stock (Tons)", blockPricePerTon: "Block Price", transportCostPerTon: "Transport Cost",
            stoneDensity: "Density (kg/m³)", avgBlockLength: "Avg. Length", avgBlockHeight: "Avg. Height", avgBlockWidth: "Avg. Width",
            trimmingCM: "Trimming Waste (cm)", slabThickness: "Slab Thickness", bladeThickness: "Blade Thickness",
            gangSaws: "Gang Saws Count", downfeedSpeed: "Cutting Speed", consumablesCostPerM2: "Consumables/m²",
            electricityCostMonthly: "Electricity Cost", waterCostMonthly: "Water Cost", laborCostMonthly: "Labor Cost",
            rentMonthly: "Rent", miscCostMonthly: "Misc. Expenses", shiftsPerDay: "Shifts/Day",
            hoursPerShift: "Hours/Shift", daysPerMonth: "Days/Month", baseSellPrice: "Domestic Price",
            exportSellPrice: "Export Price ($)", exportSharePercent: "Export Share (%)", exchangeRate: "Exchange Rate",
            crackRiskPercent: "Crack Risk", aestheticDropPercent: "Quality Drop Risk", useEpoxyLine: "Epoxy Line",
            epoxyLineCostPerM2: "Resin Cost", machineReliability: "Machine Health", powerOutageProb: "Power Outage Prob.",
            bladeDeviationProb: "Blade Deviation Prob.", absenteeismProb: "Absenteeism Prob.",
            salesRatio: "Sales Ratio (%)"
        };

        const KPI_INFO = {
            profit: { title: "Net Profit", desc: "Final profit earned after deducting all fixed costs (rent, labor), variable costs (electricity, water, consumables), and COGS from total revenue." },
            production: { title: "Useful Production", desc: "Total area of sellable slabs (Super, Premium, Grade 1 & 2) produced in this period." },
            cogs: { title: "Cost Per m² (COGS)", desc: "Final cost to produce one square meter of slab. Includes raw stone, cutting, polishing, resin, and energy." },
            yield: { title: "Processing Yield", desc: "Ratio of useful stone output weight to block input weight. Industry standard is 50-60%." }
        };

        const EXPLANATIONS = {
            totalStockTons: "Total raw stone (block) inventory in the factory in tons.",
            blockPricePerTon: "Purchase price of raw stone per ton from the mine.",
            transportCostPerTon: "Transportation cost per ton from mine to factory.",
            stoneDensity: "Stone density (kg/m³). Marble is usually 2700, Granite 2800.",
            avgBlockLength: "Average length of blocks in stock (m).",
            avgBlockHeight: "Average height of blocks in stock (m).",
            avgBlockWidth: "Average width of blocks in stock (m).",
            trimmingCM: "Amount of waste for squaring the block (cm).",
            slabThickness: "Final slab thickness (mm).",
            bladeThickness: "Cutting blade thickness (mm).",
            gangSaws: "Number of active gang saw machines.",
            downfeedSpeed: "Blade downfeed speed (cm/h).",
            consumablesCostPerM2: "Cost of abrasives, water, and consumables per square meter.",
            electricityCostMonthly: "Monthly electricity bill.",
            waterCostMonthly: "Monthly water bill.",
            laborCostMonthly: "Total monthly labor costs and salaries.",
            rentMonthly: "Monthly rent or opportunity cost of the property.",
            miscCostMonthly: "Maintenance and miscellaneous expenses.",
            shiftsPerDay: "Number of working shifts per day.",
            hoursPerShift: "Effective working hours per shift.",
            daysPerMonth: "Number of working days per month.",
            baseSellPrice: "Selling price per square meter in the domestic market.",
            exportSellPrice: "Export selling price ($).",
            exportSharePercent: "Percentage of production exported.",
            exchangeRate: "Exchange rate (Currency to USD).",
            crackRiskPercent: "Probability of stone cracking under the machine.",
            aestheticDropPercent: "Probability of stone quality degradation.",
            useEpoxyLine: "Use of mesh and resin (increases quality and cost).",
            epoxyLineCostPerM2: "Cost of resin and mesh per square meter.",
            machineReliability: "Percentage of machine health/uptime.",
            powerOutageProb: "Probability of power outage (%).",
            bladeDeviationProb: "Probability of blade deviation (%).",
            absenteeismProb: "Percentage of personnel absenteeism.",
            salesRatio: "What percentage of monthly production is sold?"
        };

        // Converted defaults to roughly USD/International Standard values
        const DEFAULT_CONFIG = {
            totalStockTons: 500, blockPricePerTon: 90, transportCostPerTon: 10, stoneDensity: 2700,
            avgBlockLength: 2.8, avgBlockHeight: 1.7, avgBlockWidth: 1.5, trimmingCM: 10,
            slabThickness: 20, bladeThickness: 4.5, gangSaws: 2, bladesPerGangsaw: 80, downfeedSpeed: 25,
            consumablesCostPerM2: 0.9, electricityCostMonthly: 3000, waterCostMonthly: 400,
            laborCostMonthly: 12000, rentMonthly: 1000, miscCostMonthly: 200,
            shiftsPerDay: 2, hoursPerShift: 8, daysPerMonth: 26, baseSellPrice: 15,
            exportSellPrice: 25, exportSharePercent: 0, exchangeRate: 1, // 1:1 since we are using base currency as USD-like
            crackRiskPercent: 8, aestheticDropPercent: 15, machineReliability: 95,
            powerOutageProb: 2, bladeDeviationProb: 5, absenteeismProb: 3,
            useEpoxyLine: false, epoxyLineCostPerM2: 2.5,
            salesRatio: 90
        };

        // --- COMPONENTS ---

        const NameSetupView = ({ isOpen, onSave }) => {
            const [name, setName] = useState('');
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] bg-slate-900 flex flex-col items-center justify-center p-6 text-white animate-fade-in">
                    <div className="w-full max-w-md">
                        <div className="flex justify-center mb-8">
                            <div className="w-24 h-24 bg-blue-600 rounded-3xl flex items-center justify-center shadow-lg shadow-blue-500/30 animate-float">
                                <span className="scale-[2.5] text-white">{Icons.Factory}</span>
                            </div>
                        </div>
                        <h2 className="text-3xl md:text-4xl font-black text-center mb-4 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">Factory Setup</h2>
                        <p className="text-slate-300 text-center mb-10 text-sm md:text-base">Enter your industrial unit's name to begin simulation.</p>
                        
                        <div className="bg-slate-800 p-2 rounded-2xl border border-slate-700 mb-8 shadow-xl">
                            <input 
                                type="text" 
                                value={name} 
                                onChange={(e) => setName(e.target.value)} 
                                placeholder="e.g. Modern Stone Works" 
                                className="w-full bg-slate-900 text-white font-bold text-center py-5 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all placeholder-slate-500 text-xl md:text-2xl"
                            />
                        </div>
                        
                        <button 
                            onClick={() => onSave(name || 'My Factory')} 
                            className="w-full py-5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white rounded-xl font-bold shadow-xl transition-all active:scale-95 flex items-center justify-center gap-3 text-lg"
                        >
                            Register & Continue {Icons.Next}
                        </button>
                    </div>
                </div>
            );
        };

        // --- INPUT SUMMARY TABLE COMPONENT ---
        const InputSummaryTable = ({ config }) => (
            <div className="mt-12 pt-8 border-t-2 border-slate-700/50 print:break-before-page">
                <h3 className="text-xl font-black text-white print:text-black mb-6 flex items-center gap-2">
                    {Icons.Clipboard} 
                    <span>Simulation Inputs & Specs</span>
                </h3>
                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 text-sm print:grid-cols-3">
                    {Object.entries(config).map(([key, value]) => {
                        const label = LABELS[key] || key;
                        const displayValue = typeof value === 'boolean' ? (value ? 'Yes' : 'No') : fmt(value);
                        return (
                            <div key={key} className="bg-slate-800/50 print:bg-slate-100 p-3 rounded-lg border border-slate-700 print:border-slate-300">
                                <div className="text-slate-400 print:text-slate-600 text-xs mb-1">{label}</div>
                                <div className="font-bold text-slate-200 print:text-black">{displayValue}</div>
                            </div>
                        );
                    })}
                </div>
            </div>
        );

        const DisclaimerModal = ({ isOpen, onAccept }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 modal-backdrop">
                    <div className="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh] border border-slate-700">
                        <div className="bg-rose-900/30 p-6 border-b border-rose-900/30 flex items-center gap-4 shrink-0">
                            <div className="text-rose-500 p-2 bg-rose-500/10 rounded-lg">{Icons.Alert}</div>
                            <h2 className="text-2xl font-black text-rose-500">Legal Disclaimer</h2>
                        </div>
                        <div className="p-8 overflow-y-auto custom-scroll">
                            <p className="text-base text-slate-300 leading-8 text-justify font-medium">
                                Dear User,
                                <br/><br/>
                                The results provided by the "Stone Production Simulation" software are calculated solely based on simulation algorithms and your input data. These results are estimates and may differ from complex operational realities and precise accounting.
                                <br/><br/>
                                The creators of this software accept no responsibility for commercial, financial, or strategic decisions made based on these outputs. Please always consult financial experts for final decision-making.
                            </p>
                        </div>
                        <div className="p-6 bg-slate-900 border-t border-slate-800 shrink-0 flex flex-col gap-4">
                            <button onClick={onAccept} className="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold transition-all shadow-lg active:scale-95 text-base">I Accept & Continue</button>
                            <div className="text-center text-xs text-slate-400 font-mono font-bold">
                                COPYRIGHT © 2025-2026 Ali Amirkhani & Barat Stone Factory. All rights reserved.
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TourModal = ({ isOpen, onClose, step, onNext }) => {
            if (!isOpen) return null;
            const steps = [
                { 
                    title: "Welcome to the Smart Simulator", 
                    text: "This software is a comprehensive tool for managing and forecasting the profitability of your stone factory. By combining technical, financial, and risk parameters, draw a clear picture of your production future." 
                },
                { 
                    title: "5-Step Input Wizard", 
                    text: "Enter information in the sidebar in order: 1. Block Specs 2. Production Line 3. Operating Costs 4. Market & Pricing 5. Risk Management." 
                },
                { 
                    title: "Real-time Visualizer", 
                    text: "See the impact of every number change instantly in the graphic section. This includes 3D block representation, machinery, cost charts, and production line health status." 
                },
                { 
                    title: "Risk & Quality Simulation", 
                    text: "The smart engine simulates factors like stone cracking, power outages, and quality fluctuations. The impact of using mesh and resin (epoxy) on upgrading stone quality is also calculated." 
                },
                { 
                    title: "Comprehensive Management Reports", 
                    text: "Finally, receive a complete dashboard including Net Profit, Cost of Goods Sold (COGS), Break-even Analysis, and Cost Charts. PDF printing and saving capability is also provided." 
                }
            ];
            const current = steps[step] || steps[0];
            return (
                <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 modal-backdrop">
                    <div className="glass-panel w-full max-w-md p-8 relative border-t-4 border-blue-500 text-white shadow-2xl">
                        <h3 className="text-2xl font-black text-white mb-4">{current.title}</h3>
                        <p className="text-base text-slate-300 mb-8 min-h-[80px] leading-7">{current.text}</p>
                        <div className="flex justify-between items-center">
                            <div className="flex gap-2">{steps.map((_, i) => <div key={i} className={`w-2.5 h-2.5 rounded-full transition-colors ${i === step ? 'bg-blue-500 scale-125' : 'bg-slate-600'}`}></div>)}</div>
                            <button onClick={step < steps.length - 1 ? onNext : onClose} className="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-bold transition-all shadow-md">{step < steps.length - 1 ? 'Next' : 'Start'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const RestartModal = ({ isOpen, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 modal-backdrop">
                    <div className="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 border border-slate-700 animate-fade-in">
                        <div className="flex flex-col items-center text-center gap-4">
                            <div className="w-12 h-12 bg-rose-500/20 rounded-full flex items-center justify-center text-rose-500 mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                            </div>
                            <h3 className="text-xl font-bold text-white">Restart Application?</h3>
                            <p className="text-sm text-slate-400 leading-6">
                                Are you sure? This will clear all current settings and data, returning you to the start screen.
                            </p>
                            <div className="flex gap-3 w-full mt-2">
                                <button onClick={onCancel} className="flex-1 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold transition-colors">Cancel</button>
                                <button onClick={onConfirm} className="flex-1 py-2.5 bg-rose-600 hover:bg-rose-500 text-white rounded-xl font-bold transition-colors shadow-lg shadow-rose-900/20">Yes, Restart</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const StatCard = ({ id, value, unit, trend, color = "blue", icon }) => {
            const info = KPI_INFO[id] || {};
            return (
                <div className={`glass-panel p-6 relative overflow-hidden group`}>
                    <div className={`absolute top-0 right-0 w-1.5 h-full bg-${color}-500 transition-all group-hover:w-2`}></div>
                    <div className="flex justify-between items-start mb-3">
                        <div className="text-xs font-bold text-slate-300 uppercase tracking-widest">{info.title}</div>
                        <div className={`text-${color}-400 bg-${color}-500/10 p-2.5 rounded-xl transition-transform group-hover:scale-110`}>{icon}</div>
                    </div>
                    <div className="text-3xl font-black text-white mb-1 flex items-baseline gap-1">
                        {value} <span className="text-sm font-bold text-slate-400">{unit}</span>
                    </div>
                    {trend && (
                        <div className={`text-[11px] font-bold inline-flex items-center gap-1 px-2.5 py-1 rounded-full mt-1 ${trend === 'good' ? 'bg-emerald-500/10 text-emerald-400' : 'bg-rose-500/10 text-rose-400'}`}>
                            {trend === 'good' ? '▲ Good Status' : '▼ Needs Review'}
                        </div>
                    )}
                    <div className="mt-4 pt-4 border-t border-white/5 text-[11px] text-slate-400 leading-relaxed font-light">
                        {info.desc}
                    </div>
                </div>
            );
        };

        const InputToggle = ({ checked, onChange }) => (
            <div className="relative inline-flex items-center cursor-pointer group shrink-0" onClick={(e) => { e.stopPropagation(); onChange(!checked); }}>
                <div className={`w-9 h-5 rounded-full transition-colors duration-200 ease-in-out border border-transparent ${checked ? 'bg-blue-600' : 'bg-slate-600'}`}></div>
                <div className={`absolute top-[2px] left-[2px] bg-white rounded-full h-4 w-4 shadow-sm transition-transform duration-200 ease-in-out ${checked ? 'translate-x-4' : 'translate-x-0'}`}></div>
            </div>
        );

        const Toggle = ({ checked, onChange }) => (
            <div className="relative inline-flex items-center cursor-pointer group shrink-0" onClick={(e) => { e.stopPropagation(); onChange(!checked); }}>
                <div className={`w-11 h-7 rounded-full transition-colors duration-300 ease-in-out border-2 border-transparent ${checked ? 'bg-blue-600' : 'bg-slate-600'}`}></div>
                <div className={`absolute top-[4px] left-[4px] bg-white rounded-full h-5 w-5 shadow-sm transition-transform duration-300 ease-in-out ${checked ? 'translate-x-4' : 'translate-x-0'}`}></div>
            </div>
        );

        const InputField = ({ labelKey, label, value, onChange, unit, disabled, type="number", step, onToggle, isToggled, canToggle }) => {
            const desc = EXPLANATIONS[labelKey] || "Description for this input.";
            const [displayVal, setDisplayVal] = useState(value);
            
            useEffect(() => {
                if (document.activeElement !== document.getElementById(`input-${labelKey}`)) {
                   setDisplayVal(value !== '' ? (type === 'number' ? fmt(value) : value) : ''); 
                }
            }, [value]);

            const handleFocus = (e) => {
                setDisplayVal(value); 
            };

            const handleBlur = (e) => {
                setDisplayVal(value !== '' ? (type === 'number' ? fmt(value) : value) : '');
            };

            const handleChange = (e) => {
                let val = e.target.value;
                setDisplayVal(val);
                if (type === 'number') {
                    const cleanVal = parseFormattedNumber(val);
                     if (cleanVal === '') onChange('');
                    else onChange(cleanVal); 
                } else onChange(val);
            };

            const handleToggleClick = (e) => {
                if (canToggle && onToggle) {
                    e.preventDefault();
                    onToggle();
                }
            };

            return (
                <div className={`wizard-input-group mb-5 ${!isToggled && canToggle ? 'opacity-50 grayscale' : ''}`}>
                    <label 
                        className={`text-xs font-bold text-slate-200 mb-2 flex items-center gap-2 select-none ${canToggle ? 'cursor-pointer hover:text-blue-400 transition-colors' : ''}`} 
                        onClick={handleToggleClick}
                    >
                        {canToggle && <InputToggle checked={isToggled} onChange={onToggle} />}
                        {label}
                    </label>
                    <div className="relative group">
                        <input 
                            id={`input-${labelKey}`}
                            type="text" 
                            inputMode={type === 'number' ? 'decimal' : 'text'}
                            value={displayVal}
                            onChange={handleChange} 
                            onFocus={handleFocus}
                            onBlur={handleBlur}
                            disabled={disabled || (canToggle && !isToggled)} 
                            className={`w-full bg-slate-800 border border-slate-600 text-white text-base font-bold rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all ${unit ? 'pr-12' : ''} disabled:bg-slate-900 disabled:text-slate-600 shadow-sm group-hover:border-slate-500`} 
                        />
                         {unit && <span className="absolute right-4 top-3.5 text-xs font-bold text-slate-400 pointer-events-none select-none">{unit}</span>}
                    </div>
                    <div className="mt-1.5 text-[11px] text-slate-400 leading-5 pr-1">{desc}</div>
                </div>
            );
        };

        // --- FLUENT VISUALIZER COMPONENT ---
        const Visualizer = ({ step, config, activeParams }) => {
            
            const renderStaticContent = () => {
                const maxDim = Math.max(config.avgBlockLength || 1, config.avgBlockHeight || 1, config.avgBlockWidth || 1);
                const BASE_SIZE = 280; 
                const scale = BASE_SIZE / (maxDim || 1); 
                
                const L = (config.avgBlockLength || 2.8) * scale;
                const H = (config.avgBlockHeight || 1.7) * scale;
                const W = (config.avgBlockWidth || 1.5) * scale;

                switch(step) {
                    case 'specs':
                        return (
                            <div className="scene-3d">
                                <div className="schematic-wrapper" style={{ width: L, height: H }}>
                                    {/* Front Face: Length & Height */}
                                    <div className="schematic-face face-front" style={{ width: L, height: H, transform: `translateZ(${W/2}px)` }}>
                                        <div className="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-20">
                                            <span className="bg-slate-900/90 text-sky-300 text-sm font-black px-3 py-1 rounded-md border border-sky-500/50 backdrop-blur-xl shadow-[0_0_15px_rgba(0,0,0,0.5)] whitespace-nowrap">
                                                Len: {fmt(config.avgBlockLength)}m
                                            </span>
                                        </div>
                                        
                                        <div className="absolute left-6 top-1/2 transform -translate-y-1/2 z-20">
                                            <span className="block bg-slate-900/90 text-sky-300 text-sm font-black px-3 py-1 rounded-md border border-sky-500/50 backdrop-blur-xl shadow-[0_0_15px_rgba(0,0,0,0.5)] whitespace-nowrap -rotate-90 origin-center">
                                                Hgt: {fmt(config.avgBlockHeight)}m
                                            </span>
                                        </div>
                                    </div>

                                    <div className="schematic-face face-back" style={{ width: L, height: H, transform: `rotateY(180deg) translateZ(${W/2}px)` }}></div>
                                    
                                    <div className="schematic-face face-right" style={{ width: W, height: H, transform: `rotateY(90deg) translateZ(${L/2}px)` }}>
                                        <div className="absolute bottom-6 left-1/2 transform -translate-x-1/2 z-20">
                                            <span className="bg-slate-900/90 text-sky-300 text-sm font-black px-3 py-1 rounded-md border border-sky-500/50 backdrop-blur-xl shadow-[0_0_15px_rgba(0,0,0,0.5)] whitespace-nowrap">
                                                Wid: {fmt(config.avgBlockWidth)}m
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div className="schematic-face face-left" style={{ width: W, height: H, transform: `rotateY(-90deg) translateZ(${L/2}px)` }}></div>
                                    <div className="schematic-face face-top" style={{ width: L, height: W, transform: `rotateX(90deg) translateZ(${H/2}px)` }}></div>
                                    <div className="schematic-face face-bottom" style={{ width: L, height: W, transform: `rotateX(-90deg) translateZ(${H/2}px)` }}></div>
                                </div>
                            </div>
                        );

                    case 'production':
                        return (
                            <div className="scene-3d flex-col">
                                <div className="machine-base"></div>
                                <div className="relative" style={{ perspective: '800px' }}>
                                    <div className="machine-frame">
                                        <div className="saw-blades"></div>
                                    </div>
                                    <div style={{ 
                                        width: 220, height: 120, background: '#64748b', 
                                        position: 'absolute', bottom: 40, left: '50%', transform: 'translateX(-50%) translateZ(-50px)',
                                        boxShadow: 'inset 0 0 30px rgba(0,0,0,0.6)' 
                                    }}>
                                        <div className="absolute top-0 w-full h-full flex justify-center opacity-30">
                                            {[...Array(6)].map((_,i) => <div key={i} className="w-1 h-full bg-black mx-5"></div>)}
                                        </div>
                                    </div>
                                </div>
                                <div className="mt-10 flex gap-6">
                                    <div className="dim-tag bg-slate-900 border-emerald-500 text-emerald-400">
                                        {fmt(config.gangSaws)} Active Units
                                    </div>
                                    <div className="dim-tag bg-slate-900 border-blue-500 text-blue-400">
                                        Thickness: {fmt(config.slabThickness)}mm
                                    </div>
                                </div>
                            </div>
                        );

                    case 'costs':
                        const overheadValue = (activeParams.rent ? Number(config.rentMonthly) : 0) + (activeParams.misc ? Number(config.miscCostMonthly) : 0);
                        
                        const costs = [
                            { id: 'labor', l: 'Labor', v: activeParams.labor ? Number(config.laborCostMonthly) : 0, c: 'bg-blue-500' },
                            { id: 'energy', l: 'Energy', v: Number(config.electricityCostMonthly) + Number(config.waterCostMonthly), c: 'bg-amber-500' },
                            { id: 'overhead', l: 'Overhead', v: overheadValue, c: 'bg-rose-500' }
                        ];
                        
                        const maxCost = Math.max(...costs.map(c => c.v)) || 1;
                        
                        return (
                            <div className="flex items-end justify-center h-full gap-16 px-16 relative" style={{ height: '350px' }}>
                                {costs.map((c) => (
                                    <div key={c.id} className="flex flex-col items-center gap-4 group w-36 h-full justify-end cursor-default">
                                        <div className="text-base font-bold text-white bg-slate-800 px-4 py-2 rounded-lg shadow-lg opacity-100 transition-all duration-300 transform group-hover:-translate-y-2 border border-slate-700 whitespace-nowrap z-20">
                                            {fmt(c.v)}
                                        </div>
                                        <div 
                                            className={`w-full rounded-t-2xl ${c.c} relative transition-all duration-700 ease-out shadow-2xl`}
                                            style={{ 
                                                height: Math.max(10, (c.v / maxCost) * 100) + '%',
                                                boxShadow: '0 0 30px rgba(0,0,0,0.4), inset 0 0 30px rgba(255,255,255,0.2)'
                                            }}
                                        >
                                            <div className="absolute top-0 w-full h-1.5 bg-white/40"></div>
                                        </div>
                                        <div className="text-xl font-bold text-slate-200 mt-2 transition-colors group-hover:text-white">{c.l}</div>
                                    </div>
                                ))}
                            </div>
                        );

                    case 'market':
                        return (
                            <div className="scene-3d flex-col w-full h-full relative">
                                <div className="market-globe absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2 z-0">
                                    <div className="globe-grid"></div>
                                    <div className="absolute top-1/2 left-1/2 w-6 h-6 bg-white rounded-full shadow-[0_0_40px_white]" style={{ transform: 'translate(-50%, -50%)' }}></div>
                                </div>
                                <div className="absolute w-full h-full z-10 pointer-events-none">
                                     <div className="absolute top-1/2 right-[5%] transform -translate-y-1/2 glass-panel p-6 flex flex-col items-center border-l-4 border-blue-500 animate-fade-in pointer-events-auto hover:scale-105 transition-transform">
                                        <div className="text-sm text-slate-300 uppercase font-bold tracking-widest mb-2">Domestic</div>
                                        <div className="text-3xl font-black text-white">{fmt(config.baseSellPrice)} <span className="text-sm text-slate-400">$</span></div>
                                    </div>

                                    {activeParams.export && (
                                        <div className="absolute top-1/2 left-[5%] transform -translate-y-1/2 glass-panel p-6 flex flex-col items-center border-r-4 border-emerald-500 animate-fade-in pointer-events-auto hover:scale-105 transition-transform">
                                            <div className="text-sm text-emerald-300 uppercase font-bold tracking-widest mb-2">Global Export</div>
                                            <div className="text-3xl font-black text-white">{fmt(config.exportSellPrice)} <span className="text-sm text-slate-400">$</span></div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        );

                    case 'risks':
                        const healthValue = activeParams.risks ? config.machineReliability : 100;
                        return (
                            <div className="scene-3d">
                                <div className="glass-panel p-12 flex flex-col items-center gap-10 w-[450px] border-t-4 border-rose-500">
                                    <div className="relative w-48 h-48">
                                        <svg viewBox="0 0 36 36" className="w-full h-full block transform -rotate-90">
                                            <path className="text-slate-600" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" />
                                            <path className="text-emerald-500 drop-shadow-[0_0_15px_rgba(16,185,129,0.6)]" strokeDasharray={`${healthValue}, 100`} d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" style={{ transition: 'stroke-dasharray 1.5s cubic-bezier(0.4, 0, 0.2, 1)' }} />
                                        </svg>
                                        <div className="absolute inset-0 flex items-center justify-center flex-col">
                                            <span className="text-5xl font-black text-white">{fmt(healthValue)}%</span>
                                            <span className="text-xs font-bold text-slate-400 mt-2 tracking-widest">HEALTH</span>
                                        </div>
                                    </div>
                                    <div className="w-full grid grid-cols-2 gap-6">
                                        <div className="bg-rose-500/10 border border-rose-500/30 p-4 rounded-xl text-center transition-all hover:bg-rose-500/20">
                                            <div className="text-xs font-bold text-rose-300 mb-2 uppercase">Crack Risk</div>
                                            <div className="text-2xl font-black text-white">{fmt(activeParams.risks ? config.crackRiskPercent : 0)}%</div>
                                        </div>
                                        <div className="bg-amber-500/10 border border-amber-500/30 p-4 rounded-xl text-center transition-all hover:bg-amber-500/20">
                                            <div className="text-xs font-bold text-amber-300 mb-2 uppercase">Power Outage</div>
                                            <div className="text-2xl font-black text-white">{fmt(activeParams.risks ? config.powerOutageProb : 0)}%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );

                    default: return null;
                }
            };

            return (
                <div className="h-full w-full fluent-viewport flex flex-col relative select-none">
                    <div className="fluent-mesh"></div>
                    <div className="absolute top-8 left-8 z-10 flex items-center gap-4 bg-slate-800/90 px-6 py-4 rounded-2xl border border-slate-700 backdrop-blur-md shadow-2xl pointer-events-none animate-fade-in">
                        <div className="w-3.5 h-3.5 bg-blue-500 rounded-full shadow-[0_0_15px_#3b82f6] animate-pulse"></div>
                        <span className="text-base font-bold text-slate-100 tracking-wide uppercase">Visualizer: {step === 'specs' ? 'Specs' : step === 'production' ? 'Production' : step === 'costs' ? 'Costs' : step === 'market' ? 'Market' : 'Risks'}</span>
                    </div>
                    <div className="relative z-10 w-full h-full p-8 flex items-center justify-center overflow-hidden">
                        {renderStaticContent()}
                    </div>
                </div>
            );
        };

        // --- DASHBOARD ---
        const DashboardView = ({ data, config, factoryName }) => {
            const costChartRef = useRef(null);
            const qualityChartRef = useRef(null);
            const chartInstances = useRef({});

            const revenue = data.revenue;
            const cogs = data.costs.material + data.costs.variable + data.costs.labor + data.costs.energy; 
            const grossProfit = revenue - cogs;
            const opex = data.costs.overhead;
            const netIncome = data.profit; 
            const unsoldStock = data.unsoldStock || 0;

            useEffect(() => {
                if (chartInstances.current.cost) chartInstances.current.cost.destroy();
                if (chartInstances.current.quality) chartInstances.current.quality.destroy();

                Chart.defaults.font.family = 'Inter';
                Chart.defaults.color = '#cbd5e1'; 

                if (costChartRef.current) {
                    chartInstances.current.cost = new Chart(costChartRef.current, {
                        type: 'doughnut',
                        data: {
                            labels: ['Raw Material', 'Labor', 'Overhead', 'Energy/Cons.'],
                            datasets: [{ 
                                data: [data.costs.material, data.costs.labor, data.costs.overhead, data.costs.energy + data.costs.variable], 
                                backgroundColor: ['#475569', '#3b82f6', '#f43f5e', '#f59e0b'], 
                                borderWidth: 0,
                                borderColor: '#1e293b' 
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { 
                                legend: { position: 'right', labels: { usePointStyle: true, font: { size: 12, family: 'Inter' }, color: '#cbd5e1', padding: 20 } } 
                            },
                            layout: { padding: 20 }
                        }
                    });
                }
                if (qualityChartRef.current) {
                    chartInstances.current.quality = new Chart(qualityChartRef.current, {
                        type: 'bar',
                        data: {
                            labels: ['Super', 'Premium', 'Grade 1', 'Grade 2', 'Waste'],
                            datasets: [{ 
                                label: 'Meters Sq.', 
                                data: [data.quality.super, data.quality.mumtaz, data.quality.d1, data.quality.d2, data.quality.zayeat], 
                                backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#f97316', '#ef4444'], 
                                borderRadius: 6,
                                borderSkipped: false
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { legend: { display: false } }, 
                            scales: { 
                                y: { 
                                    beginAtZero: true, 
                                    grid: { color: '#334155', tickLength: 0 }, 
                                    ticks: { color: '#cbd5e1', font: { family: 'Inter' }, callback: (val) => fmt(val), padding: 10 },
                                    border: { display: false }
                                }, 
                                x: { 
                                    grid: { display: false }, 
                                    ticks: { color: '#cbd5e1', font: { family: 'Inter' }, padding: 10 },
                                    border: { display: false }
                                } 
                            },
                            layout: { padding: 10 }
                        }
                    });
                }
                return () => { Object.values(chartInstances.current).forEach(c => c && c.destroy()); }
            }, [data]);

            const topCost = Object.entries(data.costs).sort((a,b) => b[1]-a[1])[0];
            const costLabels = { material: 'Raw Material', labor: 'Labor', overhead: 'Overhead', energy: 'Energy', variable: 'Variable' };
            const margin = (netIncome / revenue) * 100;

            return (
                <div className="space-y-8 animate-fade-in pb-24 w-full max-w-7xl mx-auto px-6">
                    
                    {/* --- PRINT REPORT HEADER --- */}
                    <div className="hidden print:flex flex-col mb-8 border-b-2 border-slate-800 pb-6 w-full">
                        <div className="flex flex-row items-center justify-between w-full px-2">
                            {/* Left Side: Logo & Title */}
                            <div className="flex items-center gap-6">
                                <div className="w-24 h-24 scale-110">{Icons.Logo}</div>
                                <div className="flex flex-col justify-center">
                                    <h1 className="text-4xl font-black text-slate-900 tracking-tight" style={{ fontFamily: 'sans-serif' }}>Stone Production Simulation</h1>
                                    <div className="text-lg font-bold text-slate-600 mt-1 uppercase tracking-widest">Integrated Analysis Report</div>
                                </div>
                            </div>
                            
                            {/* Right Side: Factory Info & Date */}
                            <div className="flex flex-col items-end gap-3">
                                <div className="bg-slate-100 border-2 border-slate-800 px-8 py-4 rounded-xl min-w-[300px] shadow-sm">
                                    <div className="text-xs text-slate-500 font-bold mb-1 text-right uppercase tracking-wider">Industrial Unit</div>
                                    <div className="text-2xl font-black text-slate-900 text-right truncate">{factoryName}</div>
                                </div>
                                <div className="flex items-center gap-2 text-xs font-bold text-slate-500 bg-white border border-slate-300 px-3 py-1.5 rounded-lg">
                                    <span className="text-slate-400 uppercase tracking-wider">Date & Time:</span>
                                    <span className="font-mono text-slate-900 text-sm">
                                        {new Date().toLocaleString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div className="mt-6 flex justify-between items-end border-t border-dashed border-slate-300 pt-3 px-2">
                            <div className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Confidential Simulation Report</div>
                            <div className="text-[10px] text-slate-500 font-mono font-bold">
                                COPYRIGHT © 2025-2026 Ali Amirkhani & Barat Stone Factory. All rights reserved.
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 print:grid-cols-2">
                        <StatCard id="profit" value={fmt(data.profit)} unit="$" trend={data.profit > 0 ? 'good' : 'bad'} color={data.profit > 0 ? 'emerald' : 'rose'} icon={Icons.Dollar} />
                        <StatCard id="production" value={fmt(data.production)} unit="m²" trend="good" color="blue" icon={Icons.Production} />
                        <StatCard id="cogs" value={fmt(cogs / (data.production || 1))} unit="$" color="amber" icon={Icons.TrendingUp} />
                        <StatCard id="yield" value={fmt(data.yield)} unit="%" trend={data.yield > 55 ? 'good' : 'bad'} color="indigo" icon={Icons.Zap} />
                    </div>

                    <div className="glass-panel overflow-hidden print:shadow-none print:border print:border-slate-300">
                        <div className="bg-slate-800/80 px-8 py-5 border-b border-white/5 flex justify-between items-center backdrop-blur-md print:bg-slate-200 print:text-black">
                            <h3 className="font-bold text-white text-lg print:text-black">Profit & Loss Statement (P&L)</h3>
                            <span className="text-xs text-slate-400 font-mono tracking-wider bg-slate-900 px-3 py-1 rounded-full print:hidden">GAAP Standard</span>
                        </div>
                        <div className="p-0 overflow-x-auto">
                            <table className="w-full text-base text-left whitespace-nowrap">
                                <tbody className="divide-y divide-slate-700/50 print:divide-slate-300">
                                    <tr className="hover:bg-slate-800/30 transition-colors print:text-black">
                                        <td className="px-8 py-5">
                                            <div className="font-bold text-slate-200 print:text-black">Total Revenue</div>
                                            <div className="text-xs text-slate-500 mt-1">Income from sales of all produced slabs</div>
                                        </td>
                                        <td className="px-8 py-5 text-center text-slate-200 font-bold text-xl print:text-black">{fmt(revenue)}</td>
                                    </tr>
                                    <tr className="hover:bg-slate-800/30 transition-colors print:text-black">
                                        <td className="px-8 py-5">
                                            <div className="text-slate-300 print:text-black">- Cost of Goods Sold (COGS)</div>
                                            <div className="text-xs text-slate-500 mt-1">Raw material, energy, consumables, and direct labor</div>
                                        </td>
                                        <td className="px-8 py-5 text-center text-rose-400 font-bold text-xl print:text-rose-600">({fmt(cogs)})</td>
                                    </tr>
                                    <tr className="bg-slate-800/40 print:bg-slate-100 print:text-black">
                                        <td className="px-8 py-5 border-l-4 border-blue-500">
                                            <div className="font-bold text-white print:text-black">Gross Profit</div>
                                            <div className="text-xs text-slate-400 mt-1">Operating profit before overhead expenses</div>
                                        </td>
                                        <td className="px-8 py-5 text-center text-white font-black text-xl print:text-black">{fmt(grossProfit)}</td>
                                    </tr>
                                    <tr className="hover:bg-slate-800/30 transition-colors print:text-black">
                                        <td className="px-8 py-5">
                                            <div className="text-slate-300 print:text-black">- Operating Expenses (OpEx)</div>
                                            <div className="text-xs text-slate-500 mt-1">Rent, maintenance, administrative costs</div>
                                        </td>
                                        <td className="px-8 py-5 text-center text-rose-400 font-bold text-xl print:text-rose-600">({fmt(opex)})</td>
                                    </tr>
                                    <tr className="bg-gradient-to-r from-slate-800 to-slate-900 print:bg-none print:bg-slate-200">
                                        <td className="px-8 py-6 border-l-4 border-emerald-500">
                                            <div className="font-black text-lg text-white print:text-black">Net Income</div>
                                            <div className="text-xs text-slate-400 mt-1">Final profit after all deductions</div>
                                        </td>
                                        <td className={`px-8 py-6 text-center font-black text-2xl ${netIncome > 0 ? 'text-emerald-400 print:text-emerald-700' : 'text-rose-400 print:text-rose-700'}`}>{fmt(netIncome)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 print:block print:space-y-8">
                         <div className="glass-panel p-8 flex flex-col print:shadow-none print:border print:border-slate-300 print:break-inside-avoid">
                            <h4 className="text-base font-bold text-slate-200 mb-6 border-b border-slate-700 pb-3 flex items-center gap-2 print:text-black print:border-slate-300">
                                <span className="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>
                                Cost Structure Analysis
                            </h4>
                            <div className="flex-1 relative w-full h-72"><canvas ref={costChartRef}></canvas></div>
                            <div className="mt-6 text-sm text-slate-300 leading-7 bg-slate-800/50 p-4 rounded-xl border border-slate-700 print:text-black print:bg-slate-100 print:border-slate-300">
                                <strong>Interpretation:</strong> Your largest cost component is <strong>{costLabels[topCost[0]]}</strong> with {fmt(topCost[1])}$. Managing this section will have the highest impact on your profit margin.
                            </div>
                         </div>
                         <div className="glass-panel p-8 flex flex-col print:shadow-none print:border print:border-slate-300 print:break-inside-avoid">
                             <h4 className="text-base font-bold text-slate-200 mb-6 border-b border-slate-700 pb-3 flex items-center gap-2 print:text-black print:border-slate-300">
                                <span className="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>
                                Production Quality Analysis
                             </h4>
                             <div className="flex-1 relative w-full h-72"><canvas ref={qualityChartRef}></canvas></div>
                             <div className="mt-6 text-sm text-slate-300 leading-7 bg-slate-800/50 p-4 rounded-xl border border-slate-700 print:text-black print:bg-slate-100 print:border-slate-300">
                                 <strong>Interpretation:</strong> Overall production yield is <strong>{fmt(data.yield)}%</strong>. Waste amount is {fmt(data.quality.zayeat)} m², which can be reduced by optimizing the cutting line.
                             </div>
                         </div>
                    </div>

                    <div className="bg-gradient-to-br from-blue-900/40 to-indigo-900/40 border border-blue-500/30 rounded-2xl p-8 relative overflow-hidden backdrop-blur-md shadow-lg print:bg-none print:bg-slate-100 print:border-slate-300 print:shadow-none print:text-black print:break-inside-avoid">
                         <div className="absolute top-0 left-0 p-6 opacity-10 rotate-12 scale-150 text-blue-400 print:hidden">{Icons.Info}</div>
                         <h3 className="font-bold text-blue-400 mb-4 relative z-10 flex items-center gap-3 text-lg print:text-blue-700">
                            <span className="w-2.5 h-2.5 bg-blue-500 rounded-full animate-pulse print:hidden"></span>
                            Intelligent Analysis Report
                         </h3>
                         <div className="relative z-10 space-y-4 text-base text-blue-100 leading-8 text-justify print:text-black">
                             <p>
                                 Based on the simulation, your factory is operating with a net profit margin of <strong>{fmt(margin)}%</strong>. 
                                 {margin > 20 ? ' This profitability rate is excellent.' : (margin > 0 ? ' This profitability rate is average and needs optimization.' : ' The situation is loss-making and requires immediate cost review.')}
                             </p>
                             <p>
                                 Net profit per sold square meter: <strong>{fmt(data.profit / (data.production - unsoldStock || 1))}</strong> $.
                                 This indicator shows your pricing power in the market.
                             </p>
                             <p>
                                 Amount of <strong>{fmt(unsoldStock)}</strong> m² of this period's production was not sold based on market absorption rate ({fmt(config.salesRatio)}%) and was added to inventory. This stagnant capital can challenge cash flow.
                             </p>
                             {config.useEpoxyLine && <p className="text-indigo-300 font-bold bg-indigo-900/50 p-3 rounded-lg border border-indigo-500/30 print:text-indigo-700 print:bg-indigo-50 print:border-indigo-200">
                                 * Technology Impact: Using the epoxy line has improved quality and reduced waste, visible in the quality chart.
                             </p>}
                         </div>
                    </div>

                    {/* Added Input Summary Table for Reports */}
                    <InputSummaryTable config={config} />

                    <div className="flex justify-center mt-8 no-print gap-4">
                        <button onClick={() => window.print()} className="bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-4 rounded-xl font-bold text-base shadow-lg transition-all flex items-center gap-3 hover:scale-105 active:scale-95">
                            {Icons.Save} Download PDF Report
                        </button>
                    </div>
                </div>
            );
        };

        const ReportModal = ({ isOpen, report, onClose }) => {
            if (!isOpen || !report) return null;
            return null;
        };

        // --- WELCOME SCREEN ---
        const WelcomeView = ({ onStart }) => (
            <div className="min-h-screen w-full flex flex-col items-center justify-center bg-slate-900 relative overflow-hidden text-white">
                <div className="absolute inset-0 z-0 opacity-20" style={{
                    backgroundImage: 'linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px)',
                    backgroundSize: '40px 40px'
                }}></div>
                <div className="absolute top-[-10%] right-[-10%] w-[600px] h-[600px] bg-blue-600/20 rounded-full blur-[100px] animate-pulse"></div>
                <div className="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-emerald-600/20 rounded-full blur-[100px] animate-pulse" style={{animationDelay: '2s'}}></div>

                <div className="relative z-10 flex flex-col items-center justify-center max-w-4xl px-6 text-center animate-fade-in">
                    <div className="w-28 h-28 bg-white/5 rounded-3xl flex items-center justify-center mb-8 backdrop-blur-md border border-white/10 shadow-2xl animate-float">
                        <span className="text-blue-400 scale-[3]">{Icons.Logo}</span>
                    </div>
                    
                    <h1 className="text-5xl md:text-8xl font-black mb-6 tracking-tight drop-shadow-2xl">
                        Stone Production <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">Simulation</span>
                    </h1>
                    
                    <p className="text-slate-300 text-lg md:text-2xl max-w-2xl mb-12 leading-relaxed font-light">
                        Intelligent Stone Manufacturing Simulator
                    </p>

                    <button onClick={onStart} className="group relative px-12 py-5 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-bold text-xl shadow-2xl shadow-blue-500/30 transition-all hover:scale-105 active:scale-95 w-full md:w-auto overflow-hidden">
                        <div className="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]"></div>
                        <span className="flex items-center justify-center gap-4">Start Operation {Icons.Next}</span>
                    </button>
                    
                    <div className="mt-20 flex flex-col items-center gap-2 opacity-90">
                        <div className="text-xs md:text-sm text-slate-300 font-mono font-bold">
                            v3.2 INTEGRATED | COPYRIGHT © 2025-2026 Ali Amirkhani & Barat Stone Factory. All rights reserved.
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('welcome');
            const [step, setStep] = useState('specs');
            const [isSimulating, setIsSimulating] = useState(false);
            const [results, setResults] = useState(null);
            
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [activeParams, setActiveParams] = useState({transport: true, export: true, labor: true, rent: true, misc: true, risks: true});
            const [factoryName, setFactoryName] = useState('');
            
            const [modals, setModals] = useState({ name: false, disclaimer: false, tour: false, restart: false });
            const [tourStep, setTourStep] = useState(0);

            // --- DISABLE INSPECT & RIGHT CLICK ---
            useEffect(() => {
                const handleContextMenu = (e) => e.preventDefault();
                
                const handleKeyDown = (e) => {
                    // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
                    if (
                        e.key === 'F12' || 
                        (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) || 
                        (e.ctrlKey && e.key === 'u')
                    ) {
                        e.preventDefault();
                    }
                };

                document.addEventListener('contextmenu', handleContextMenu);
                document.addEventListener('keydown', handleKeyDown);

                return () => {
                    document.removeEventListener('contextmenu', handleContextMenu);
                    document.removeEventListener('keydown', handleKeyDown);
                };
            }, []);

            useEffect(() => {
                const savedConfig = localStorage.getItem('slabware_config_en');
                const savedName = localStorage.getItem('slabware_factory_name_en');
                const savedParams = localStorage.getItem('slabware_active_params_en');
                
                if (savedConfig) setConfig(JSON.parse(savedConfig));
                if (savedParams) setActiveParams(JSON.parse(savedParams));
                if (savedName) setFactoryName(savedName);
            }, []);

            useEffect(() => {
                if (factoryName) localStorage.setItem('slabware_factory_name_en', factoryName);
                localStorage.setItem('slabware_config_en', JSON.stringify(config));
                localStorage.setItem('slabware_active_params_en', JSON.stringify(activeParams));
            }, [config, factoryName, activeParams]);

            const updateConfig = (key, val) => setConfig(prev => ({...prev, [key]: val}));
            const toggleParam = (key) => setActiveParams(prev => ({...prev, [key]: !prev[key]}));
            
            const handleWelcomeStart = () => {
                if (!factoryName) {
                    setModals(prev => ({ ...prev, name: true }));
                } else if (!localStorage.getItem('slabware_disclaimer_accepted_en')) {
                    setModals(prev => ({ ...prev, disclaimer: true }));
                } else {
                    setView('wizard');
                    if (!localStorage.getItem('slabware_tour_seen_en')) {
                        setTimeout(() => setModals(prev => ({ ...prev, tour: true })), 500);
                        localStorage.setItem('slabware_tour_seen_en', 'true');
                    }
                }
            };

            const handleNameSave = (name) => {
                setFactoryName(name);
                setModals(prev => ({ ...prev, name: false, disclaimer: true }));
            };

            const handleDisclaimerAccept = () => {
                localStorage.setItem('slabware_disclaimer_accepted_en', 'true');
                setModals(prev => ({ ...prev, disclaimer: false }));
                setView('wizard');
                 if (!localStorage.getItem('slabware_tour_seen_en')) {
                    setTimeout(() => setModals(prev => ({ ...prev, tour: true })), 500);
                    localStorage.setItem('slabware_tour_seen_en', 'true');
                }
            };

            const openHelpTour = () => {
                setTourStep(0);
                setModals(prev => ({ ...prev, tour: true }));
            };

            const handleRestartRequest = () => {
                setModals(prev => ({ ...prev, restart: true }));
            };

            const handleRestartConfirm = () => {
                // Reset all states to default
                setConfig({...DEFAULT_CONFIG}); 
                setActiveParams({transport: true, export: true, labor: true, rent: true, misc: true, risks: true});
                setStep('specs');
                setResults(null);
                setModals(prev => ({ ...prev, restart: false }));
                setView('welcome');
            };

            const runSimulation = () => {
                setIsSimulating(true);
                setTimeout(() => {
                    const getVal = (k, cat) => (cat && !activeParams[cat] ? 0 : Number(config[k]));
                    let currentStock = getVal('totalStockTons');
                    const labor = getVal('laborCostMonthly', 'labor');
                    const overhead = getVal('rentMonthly', 'rent') + getVal('miscCostMonthly', 'misc');
                    const energy = getVal('electricityCostMonthly') + getVal('waterCostMonthly');
                    
                    const machineRel = activeParams.risks ? getVal('machineReliability') : 100;
                    const crackRisk = activeParams.risks ? getVal('crackRiskPercent') / 100 : 0;
                    const absentProb = activeParams.risks ? getVal('absenteeismProb') / 100 : 0;
                    const bladeDevProb = activeParams.risks ? getVal('bladeDeviationProb') / 100 : 0;
                    const aestheticDrop = activeParams.risks ? getVal('aestheticDropPercent') / 100 : 0;
                    
                    const exportShare = activeParams.export ? getVal('exportSharePercent') / 100 : 0;
                    const salesRatio = getVal('salesRatio') / 100;

                    const length = getVal('avgBlockLength'), height = getVal('avgBlockHeight'), width = getVal('avgBlockWidth');
                    const weight = (length * height * width) * (getVal('stoneDensity') / 1000);
                    const slabs = Math.floor((Math.max(0, width - 0.1) * 1000) / (getVal('slabThickness') + getVal('bladeThickness')));
                    const grossM2 = slabs * Math.max(0, length - 0.1) * Math.max(0, height - 0.1);
                    const m2PerTon = weight > 0 ? grossM2 / weight : 0;

                    const hToCut = getVal('downfeedSpeed') > 0 ? (Math.max(0, height - 0.1) * 100) / getVal('downfeedSpeed') : 0;
                    const dailyCap = hToCut > 0 ? ((getVal('shiftsPerDay') * getVal('hoursPerShift')) / hToCut) * grossM2 * getVal('gangSaws') : 0;

                    let totalRev = 0, totalVC = 0, totalProd = 0, totalWaste = 0;
                    const quality = { super: 0, mumtaz: 0, d1: 0, d2: 0, zayeat: 0 };
                    
                    for(let d=1; d<=getVal('daysPerMonth'); d++) {
                        if(currentStock <= 0.5) break;
                        
                        let capMultiplier = 1;
                        if(Math.random() < ((100-machineRel)/100)) capMultiplier *= 0.2; 
                        if(Math.random() < absentProb) capMultiplier *= 0.85; 
                        
                        let cap = dailyCap * capMultiplier;
                        
                        const needed = m2PerTon > 0 ? cap / m2PerTon : 0;
                        let consumed = Math.min(needed, currentStock);
                        if(consumed < needed && m2PerTon > 0) cap = consumed * m2PerTon;
                        currentStock -= consumed;

                        let lossRate = crackRisk + (Math.random()*0.05); 
                        if(Math.random() < bladeDevProb) lossRate += 0.3;
                        
                        const loss = Math.min(1, Math.max(0, lossRate));
                        const netM2 = cap * (1 - loss);
                        const waste = cap * loss;
                        quality.zayeat += waste;

                        let randomNoise = () => (Math.random() * 0.4) - 0.2;
                        let w_super = Math.max(0.05, 0.25 + randomNoise());
                        let w_mumtaz = Math.max(0.05, 0.35 + randomNoise());
                        let w_d1 = Math.max(0.05, 0.25 + randomNoise());
                        let w_d2 = Math.max(0.05, 0.15 + randomNoise());
                        const totalW = w_super + w_mumtaz + w_d1 + w_d2;
                        
                        let g = { 
                            s: w_super / totalW, 
                            m: w_mumtaz / totalW, 
                            d1: w_d1 / totalW, 
                            d2: w_d2 / totalW 
                        };

                        if(aestheticDrop > 0 && Math.random() < 0.5) { const shift = g.s * aestheticDrop; g.s -= shift; g.d1 += shift * 0.6; g.d2 += shift * 0.4; g.s = Math.max(0, g.s); g.d1 = Math.max(0, g.d1); g.d2 = Math.max(0, g.d2); }
                        
                        let vc = netM2 * getVal('consumablesCostPerM2');
                        if(config.useEpoxyLine) { 
                            vc += netM2 * getVal('epoxyLineCostPerM2'); 
                            g.s += 0.15; g.m += 0.10; g.d1 -= 0.10; g.d2 -= 0.15;
                            const sum = g.s + g.m + g.d1 + g.d2;
                            if(sum > 0) { g.s/=sum; g.m/=sum; g.d1/=sum; g.d2/=sum; }
                        }

                        const price = (gr, exp) => (exp ? getVal('exportSellPrice')*getVal('exchangeRate') : getVal('baseSellPrice')) * (gr==='s'?1.6:gr==='m'?1.3:gr==='d1'?1.0:0.7);

                        totalRev += netM2 * salesRatio * (
                            (1-exportShare)*(g.s*price('s',0)+g.m*price('m',0)+g.d1*price('d1',0)+g.d2*price('d2',0)) + 
                            exportShare*(g.s*price('s',1)+g.m*price('m',1)+g.d1*price('d1',1)+g.d2*price('d2',1))
                        );
                        
                        quality.super += netM2*g.s; quality.mumtaz += netM2*g.m; quality.d1 += netM2*g.d1; quality.d2 += netM2*g.d2;
                        totalRev += waste * (getVal('baseSellPrice') * 0.08);
                        totalVC += vc; totalProd += netM2; totalWaste += waste;
                    }

                    const matCost = (getVal('totalStockTons') - currentStock) * (getVal('blockPricePerTon') + (activeParams.transport ? getVal('transportCostPerTon') : 0));
                    const totalCOGS = matCost + totalVC + labor + energy; 
                    const totalExpenses = totalCOGS + overhead;

                    const resultsData = {
                        revenue: totalRev, cogs: totalCOGS, profit: totalRev - totalExpenses,
                        production: totalProd, waste: totalWaste, yield: (totalProd / (totalProd+totalWaste))*100,
                        remaining: currentStock,
                        costs: { material: matCost, variable: totalVC, labor: labor, energy: energy, overhead: overhead },
                        quality, unsoldStock: totalProd * (1 - salesRatio)
                    };
                    
                    setResults(resultsData);
                    setIsSimulating(false);
                    setView('dashboard');
                }, 1000);
            };

            const wizardSteps = [
                { id: 'specs', title: 'Block Specs', icon: Icons.Box },
                { id: 'production', title: 'Production Line', icon: Icons.Layers },
                { id: 'costs', title: 'Op. Costs', icon: Icons.Dollar },
                { id: 'market', title: 'Market', icon: Icons.TrendingUp },
                { id: 'risks', title: 'Risk Mgmt', icon: Icons.Alert },
            ];
            const currentStepIdx = wizardSteps.findIndex(s => s.id === step);

            return (
                <>
                    <NameSetupView isOpen={modals.name} onSave={handleNameSave} />
                    <DisclaimerModal isOpen={modals.disclaimer} onAccept={handleDisclaimerAccept} />
                    <TourModal isOpen={modals.tour} step={tourStep} onNext={() => setTourStep(p => p + 1)} onClose={() => setModals(prev => ({...prev, tour: false}))} />
                    <RestartModal isOpen={modals.restart} onConfirm={handleRestartConfirm} onCancel={() => setModals(prev => ({...prev, restart: false}))} />

                    {view === 'welcome' && <WelcomeView factoryName={factoryName} onStart={handleWelcomeStart} />}

                    {view !== 'welcome' && (
                        <div className="flex flex-col h-screen overflow-hidden text-slate-200">
                            <nav className="bg-slate-800 border-b border-slate-700 px-4 md:px-6 py-3 flex items-center justify-between z-20 shadow-lg relative no-print shrink-0">
                                <div className="flex items-center gap-3 cursor-pointer group" onClick={() => setView('wizard')}>
                                    <div className="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center shadow-inner border border-slate-700 transition-transform group-hover:scale-105 p-1">
                                        {Icons.Logo}
                                    </div>
                                    <div><h1 className="font-black text-white text-base tracking-tight">Stone Production Simulation</h1><p className="text-[10px] text-slate-400 font-bold uppercase">Integrated v3.2</p></div>
                                </div>
                                <div className="flex items-center gap-3 md:gap-5">
                                    <button onClick={openHelpTour} className="flex flex-col items-center justify-center text-slate-400 hover:text-blue-400 transition-colors group relative">
                                        {Icons.Help}
                                        <span className="text-[10px] font-bold opacity-0 group-hover:opacity-100 transition-opacity absolute top-full mt-1 left-1/2 -translate-x-1/2 whitespace-nowrap pointer-events-none">Help</span>
                                    </button>
                                    <div className="h-8 w-px bg-slate-700"></div>
                                    <button onClick={handleRestartRequest} className="flex flex-col items-center justify-center text-slate-400 hover:text-rose-400 transition-colors group relative">
                                        {Icons.Restart}
                                        <span className="text-[10px] font-bold opacity-0 group-hover:opacity-100 transition-opacity absolute top-full mt-1 left-1/2 -translate-x-1/2 whitespace-nowrap pointer-events-none">Restart</span>
                                    </button>
                                    <div className="h-8 w-px bg-slate-700"></div>
                                    <div className="text-sm font-bold text-slate-300 truncate max-w-[100px] md:max-w-none bg-slate-700/50 px-3 py-1 rounded-lg flex items-center gap-2">
                                        {Icons.Factory}
                                        <span className="truncate">{factoryName}</span>
                                    </div>
                                </div>
                            </nav>

                            <main className="flex-1 bg-slate-900 relative flex flex-col lg:flex-row min-h-0 lg:overflow-hidden overflow-y-auto">
                                {view === 'dashboard' ? (
                                    <div className="w-full h-full overflow-y-auto custom-scroll p-4 lg:p-8">
                                        <div className="mb-6 flex items-center justify-between no-print max-w-7xl mx-auto">
                                            <h2 className="text-3xl font-black text-white flex items-center gap-3">{Icons.TrendingUp} Production Performance Report</h2>
                                            <button onClick={() => setView('wizard')} className="px-6 py-3 bg-slate-800 text-white rounded-xl text-sm font-bold shadow-lg hover:bg-slate-700 transition-all border border-slate-700 flex items-center gap-2 hover:scale-105 active:scale-95">{Icons.Back} Back to Wizard</button>
                                        </div>
                                        <DashboardView data={results} config={config} factoryName={factoryName} />
                                    </div>
                                ) : (
                                    <>
                                        {/* Input Section */}
                                        <div className="w-full lg:w-1/3 bg-slate-800 border-r border-slate-700 z-10 flex flex-col lg:h-full h-auto min-h-0 shadow-2xl relative shrink-0 order-first">
                                            <div className="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800 overflow-x-auto no-scrollbar shrink-0 sticky top-0 z-30">
                                                {wizardSteps.map((s, i) => (
                                                    <div key={s.id} onClick={() => setStep(s.id)} className={`flex flex-col items-center gap-2 min-w-[60px] cursor-pointer group transition-all ${step === s.id ? 'opacity-100 scale-110' : 'opacity-50 hover:opacity-80'}`}>
                                                        <div className={`w-9 h-9 rounded-xl flex items-center justify-center transition-all duration-300 ${step === s.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-slate-700 text-slate-400'}`}>
                                                            {i < currentStepIdx ? Icons.Check : s.icon}
                                                        </div>
                                                        <span className="text-[10px] font-bold text-slate-300 whitespace-nowrap">{s.title}</span>
                                                    </div>
                                                ))}
                                            </div>

                                            <div className="lg:flex-1 lg:overflow-y-auto w-full p-6 custom-scroll bg-slate-900/50">
                                                <div className="animate-fade-in pb-4">
                                                    <h2 className="text-2xl font-black text-white mb-8 flex items-center gap-3 sticky top-0 bg-slate-900/95 z-10 py-4 backdrop-blur-sm border-b border-slate-700/50 shadow-sm">{wizardSteps[currentStepIdx].icon} {wizardSteps[currentStepIdx].title}</h2>
                                                    
                                                    {step === 'specs' && <div className="space-y-6">
                                                        <div className="grid grid-cols-3 gap-3">
                                                            <InputField labelKey="avgBlockLength" label="Len (m)" value={config.avgBlockLength} onChange={v => updateConfig('avgBlockLength', v)} step="0.1" />
                                                            <InputField labelKey="avgBlockHeight" label="Hgt (m)" value={config.avgBlockHeight} onChange={v => updateConfig('avgBlockHeight', v)} step="0.1" />
                                                            <InputField labelKey="avgBlockWidth" label="Wid (m)" value={config.avgBlockWidth} onChange={v => updateConfig('avgBlockWidth', v)} step="0.1" />
                                                        </div>
                                                        <div className="grid grid-cols-2 gap-3">
                                                            <InputField labelKey="stoneDensity" label="Density (kg)" value={config.stoneDensity} onChange={v => updateConfig('stoneDensity', v)} />
                                                            <InputField labelKey="trimmingCM" label="Trim (cm)" value={config.trimmingCM} onChange={v => updateConfig('trimmingCM', v)} />
                                                        </div>
                                                    </div>}

                                                    {step === 'production' && <div className="space-y-6">
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <InputField labelKey="gangSaws" label="Gang Saws" value={config.gangSaws} onChange={v => updateConfig('gangSaws', v)} />
                                                            <InputField labelKey="downfeedSpeed" label="Cut Speed" value={config.downfeedSpeed} onChange={v => updateConfig('downfeedSpeed', v)} unit="cm/h" />
                                                            <InputField labelKey="slabThickness" label="Slab Thick." value={config.slabThickness} onChange={v => updateConfig('slabThickness', v)} unit="mm" />
                                                            <InputField labelKey="bladeThickness" label="Blade Thick." value={config.bladeThickness} onChange={v => updateConfig('bladeThickness', v)} unit="mm" step="0.1" />
                                                        </div>
                                                        <div className="bg-slate-800 p-4 rounded-2xl border border-slate-600 shadow-md">
                                                            <div className="text-xs font-bold text-slate-400 mb-4 uppercase tracking-wider">Production Schedule</div>
                                                            <div className="grid grid-cols-3 gap-3">
                                                                <InputField labelKey="shiftsPerDay" label="Shifts" value={config.shiftsPerDay} onChange={v => updateConfig('shiftsPerDay', v)} />
                                                                <InputField labelKey="hoursPerShift" label="Hours" value={config.hoursPerShift} onChange={v => updateConfig('hoursPerShift', v)} />
                                                                <InputField labelKey="daysPerMonth" label="Days" value={config.daysPerMonth} onChange={v => updateConfig('daysPerMonth', v)} />
                                                            </div>
                                                        </div>
                                                    </div>}

                                                    {step === 'costs' && <div className="space-y-4">
                                                        <InputField labelKey="laborCostMonthly" label="Monthly Labor" value={config.laborCostMonthly} onChange={v => updateConfig('laborCostMonthly', v)} unit="$" canToggle isToggled={activeParams.labor} onToggle={() => toggleParam('labor')} />
                                                        <div className="grid grid-cols-2 gap-3">
                                                            <InputField labelKey="electricityCostMonthly" label="Electric" value={config.electricityCostMonthly} onChange={v => updateConfig('electricityCostMonthly', v)} unit="$" />
                                                            <InputField labelKey="waterCostMonthly" label="Water" value={config.waterCostMonthly} onChange={v => updateConfig('waterCostMonthly', v)} unit="$" />
                                                        </div>
                                                        <InputField labelKey="rentMonthly" label="Rent" value={config.rentMonthly} onChange={v => updateConfig('rentMonthly', v)} unit="$" canToggle isToggled={activeParams.rent} onToggle={() => toggleParam('rent')} />
                                                        <InputField labelKey="miscCostMonthly" label="Misc. Expenses" value={config.miscCostMonthly} onChange={v => updateConfig('miscCostMonthly', v)} unit="$" canToggle isToggled={activeParams.misc} onToggle={() => toggleParam('misc')} />
                                                        <InputField labelKey="consumablesCostPerM2" label="Consumables/m²" value={config.consumablesCostPerM2} onChange={v => updateConfig('consumablesCostPerM2', v)} unit="$" />
                                                        
                                                        <div className="p-4 bg-indigo-900/20 rounded-2xl border border-indigo-500/30 transition-all hover:bg-indigo-900/30">
                                                            <div className="flex justify-between mb-3 items-center">
                                                                <span className="text-sm font-bold text-indigo-300">Advanced Epoxy Line</span>
                                                                <Toggle checked={config.useEpoxyLine} onChange={v => updateConfig('useEpoxyLine', v)} />
                                                            </div>
                                                            {config.useEpoxyLine && <InputField labelKey="epoxyLineCostPerM2" label="Resin Cost" value={config.epoxyLineCostPerM2} onChange={v => updateConfig('epoxyLineCostPerM2', v)} unit="$" />}
                                                            <div className="text-[10px] text-indigo-400 mt-2 leading-4 bg-indigo-900/40 p-2 rounded-lg">* Using epoxy in this version increases output stone quality.</div>
                                                        </div>
                                                    </div>}

                                                    {step === 'market' && <div className="space-y-6">
                                                        <InputField labelKey="totalStockTons" label="Inventory (Tons)" value={config.totalStockTons} onChange={v => updateConfig('totalStockTons', v)} />
                                                        <div className="grid grid-cols-2 gap-3">
                                                            <InputField labelKey="blockPricePerTon" label="Block Price" value={config.blockPricePerTon} onChange={v => updateConfig('blockPricePerTon', v)} unit="$" />
                                                            <InputField labelKey="transportCostPerTon" label="Transport" value={config.transportCostPerTon} onChange={v => updateConfig('transportCostPerTon', v)} unit="$" canToggle isToggled={activeParams.transport} onToggle={() => toggleParam('transport')} />
                                                        </div>
                                                        <InputField labelKey="baseSellPrice" label="Domestic Price" value={config.baseSellPrice} onChange={v => updateConfig('baseSellPrice', v)} unit="$" />
                                                        
                                                        <div className="p-4 bg-blue-900/20 rounded-2xl border border-blue-500/30 transition-all hover:bg-blue-900/30">
                                                            <div className="flex justify-between mb-3 items-center">
                                                                <span className="text-sm font-bold text-blue-300">Intl. Export</span>
                                                                <Toggle checked={activeParams.export} onChange={() => toggleParam('export')} />
                                                            </div>
                                                            {activeParams.export && <div className="grid grid-cols-2 gap-3 animate-fade-in">
                                                                <InputField labelKey="exportSharePercent" label="Share %" value={config.exportSharePercent} onChange={v => updateConfig('exportSharePercent', v)} />
                                                                <InputField labelKey="exportSellPrice" label="Price $" value={config.exportSellPrice} onChange={v => updateConfig('exportSellPrice', v)} unit="$" />
                                                                <InputField labelKey="exchangeRate" label="Exch. Rate" value={config.exchangeRate} onChange={v => updateConfig('exchangeRate', v)} unit="" />
                                                            </div>}
                                                        </div>

                                                        <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                                                            <div className="flex justify-between text-xs font-bold text-slate-400 mb-2">
                                                                <span>Market Absorption (Sales)</span>
                                                                <span className="text-blue-400 text-base">{fmt(config.salesRatio)}%</span>
                                                            </div>
                                                            <input type="range" min="0" max="100" value={config.salesRatio} onChange={(e) => updateConfig('salesRatio', Number(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer hover:bg-slate-600 transition-colors" />
                                                            <div className="mt-3 text-[10px] text-slate-500 leading-4 text-justify p-2 bg-slate-700/30 rounded-lg border border-slate-600/30">
                                                                This indicator shows what percentage of produced product is sold directly in the same period. The remainder is considered inventory (stagnant capital).
                                                            </div>
                                                        </div>
                                                    </div>}

                                                    {step === 'risks' && <div className="space-y-6">
                                                        <div className="flex justify-between items-center mb-6 bg-slate-800 p-3 rounded-xl border border-slate-700">
                                                            <span className="text-sm font-bold text-slate-200">Real-world Risk Simulation</span>
                                                            <Toggle checked={activeParams.risks} onChange={() => toggleParam('risks')} />
                                                        </div>
                                                        
                                                        <div className={`space-y-4 ${!activeParams.risks ? 'opacity-40 pointer-events-none grayscale' : ''} transition-all duration-500`}>
                                                            <div className="grid grid-cols-2 gap-4">
                                                                <InputField labelKey="machineReliability" label="Machine Health %" value={config.machineReliability} onChange={v => updateConfig('machineReliability', v)} />
                                                                <InputField labelKey="crackRiskPercent" label="Crack Risk %" value={config.crackRiskPercent} onChange={v => updateConfig('crackRiskPercent', v)} />
                                                                <InputField labelKey="powerOutageProb" label="Power Outage %" value={config.powerOutageProb} onChange={v => updateConfig('powerOutageProb', v)} />
                                                                <InputField labelKey="aestheticDropPercent" label="Quality Drop %" value={config.aestheticDropPercent} onChange={v => updateConfig('aestheticDropPercent', v)} />
                                                                <InputField labelKey="absenteeismProb" label="Absenteeism %" value={config.absenteeismProb} onChange={v => updateConfig('absenteeismProb', v)} />
                                                                <InputField labelKey="bladeDeviationProb" label="Blade Deviation %" value={config.bladeDeviationProb} onChange={v => updateConfig('bladeDeviationProb', v)} />
                                                            </div>
                                                        </div>
                                                    </div>}
                                                </div>
                                            </div>

                                            <div className="p-5 border-t border-slate-700 bg-slate-800 flex justify-between items-center shrink-0 z-20 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] sticky bottom-0 lg:static">
                                                <button onClick={() => setStep(wizardSteps[Math.max(0, currentStepIdx-1)].id)} disabled={currentStepIdx===0} className="px-6 py-3 text-slate-400 hover:text-white font-bold text-sm disabled:opacity-30 flex items-center gap-2 transition-colors">{Icons.Prev} Previous</button>
                                                
                                                {currentStepIdx === wizardSteps.length - 1 ? (
                                                    <button onClick={runSimulation} disabled={isSimulating} className="px-8 py-4 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold shadow-lg shadow-emerald-900/40 flex items-center gap-3 transition-all hover:scale-105 active:scale-95 disabled:bg-slate-700 disabled:shadow-none disabled:transform-none">
                                                        {isSimulating ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : Icons.Play}
                                                        {isSimulating ? "Processing..." : "Calculate Profit"}
                                                    </button>
                                                ) : (
                                                    <button onClick={() => setStep(wizardSteps[currentStepIdx+1].id)} className="px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold shadow-lg shadow-blue-900/40 flex items-center gap-3 transition-all hover:scale-105 active:scale-95">
                                                        Next Step {Icons.Next}
                                                    </button>
                                                )}
                                            </div>
                                        </div>

                                        {/* Visualizer Section */}
                                        <div className="w-full lg:w-2/3 bg-slate-900 relative h-[500px] lg:h-full shrink-0 order-last border-t border-slate-700 lg:border-t-0">
                                            <Visualizer step={step} config={config} activeParams={activeParams} />
                                        </div>
                                    </>
                                )}
                            </main>
                        </div>
                    )}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>